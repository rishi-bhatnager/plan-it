{% extends 'planner/base.html' %}
{% block content %}

<h2>my tasks</h2>
<ul>
{% for task in user.task_set.all %}
<li>
  <button><a href="{% url 'users:task_details' task.id %}">{{task.name|safe}}</a></button>
  </li>
  <p>Name: {{task.name|safe}}, User: {{task.user}}</p>
  <!-- <p>Notes: {{task.notes|safe}}</p> -->
  <!-- see Django's built-in template tags and filters for more ways to format properly -->
  <p>Category: {{task.get_category_display}}</p>
  <p>Date Added: {{task.getAddDate}}</p>
  <!-- <p>Date Due: {{task.getDueDate}}</p> -->
  <p>Expected Time for Completion: {{task.expTime}}</p>
  <!-- <p>Scheduled Times: {{task.times}}</p> -->
{% empty %}
  <p>you don't have any tasks</p>
{% endfor %}
  <button id="authorize_button" style="display: block;">Authorize</button>
  <button id="signout_button" style="display: none;">Sign Out</button>
  <button id="add_event" style="display:none;">Add Event</button>
  <button id="list_events" style="display:none;">List Events</button>
  <pre style="display: none" id="content" style="white-space: pre-wrap;"></pre>
<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

<script type="text/javascript">
  var CLIENT_ID = '729176283566-o6rcmm84bi77brnnudkvve7av2m9k4ua.apps.googleusercontent.com';
  var API_KEY = 'AIzaSyARKVgholwDMEQ8-Swz2RyYcuzqIYcXIcM';
  // Array of API discovery doc URLs for APIs used by the quickstart
  var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
  // Authorization scopes required by the API; multiple scopes can be
  // included, separated by spaces.
  var SCOPES = 'https://www.googleapis.com/auth/calendar.events';

  var authorizeButton = document.getElementById('authorize_button');
  var signoutButton = document.getElementById('signout_button');
  var addEvent = document.getElementById('add_event');
  var listEvents = document.getElementById('list_events');

  /**
   *
   *  On load, called to load the auth2 library and API client library.
   */
  function handleClientLoad() {
    gapi.load('client:auth2', initClient);
  }

  /**
   *  Initializes the API client library and sets up sign-in state
   *  listeners.
   */
  function initClient() {
    gapi.client.init({
      apiKey: API_KEY,
      clientId: CLIENT_ID,
      discoveryDocs: DISCOVERY_DOCS,
      scope: SCOPES
    }).then(function() {
      // Listen for sign-in state changes.
      gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

      // Handle the initial sign-in state.
      updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
      authorizeButton.onclick = handleAuthClick;
      signoutButton.onclick = handleSignoutClick;
      listEvents.onclick = listUpcomingEvents;
      addEvent.onclick = exe;
    }, function(error) {
      appendPre(JSON.stringify(error, null, 2));
    });
  }

  /**
   *  Called when the signed in status changes, to update the UI
   *  appropriately. After a sign-in, the API is called.
   */
  function updateSigninStatus(isSignedIn) {
    if (isSignedIn) {
      authorizeButton.style.display = 'none';
      signoutButton.style.display = 'block';
      addEvent.style.display = 'block';
      listEvents.style.display = 'block';
    } else {
      authorizeButton.style.display = 'block';
      signoutButton.style.display = 'none';
      addEvent.style.display = 'none';
      listEvents.style.display = 'none';
    }
  }

  function exe() {
    {% for task in user.task_set.all %}
    var schedule = createEvent('{{task.name}}', '{{task.get_category_display}}', '{{task.user}}', '{{task.getAddDate}}');
    makeRequest(schedule);

    {% endfor %}
  }
  /**
   *  Sign in the user upon button click.
   */
  function handleAuthClick(event) {
    gapi.auth2.getAuthInstance().signIn();
  }

  /**
   *  Sign out the user upon button click.
   */
  function handleSignoutClick(event) {
    gapi.auth2.getAuthInstance().signOut();
  }

  /**
   * Append a pre element to the body containing the given message
   * as its text node. Used to display the results of the API call.
   *
   * @param {string} message Text to be placed in pre element.
   */
  function appendPre(message) {
    var pre = document.getElementById('content');
    var textContent = document.createTextNode(message + '\n');
    pre.appendChild(textContent);
  }

  function replaceSlash(text) {
    for(var i=0; i < text.length; i++) {
      if (text.charAt(i) == '/') {
        text.charAt(i) = '-';
      }
    }
  }
  /**
   * Print the summary and start datetime/date of the next ten events in
   * the authorized user's calendar. If no events are found an
   * appropriate message is printed.
   */
  function createEvent(summary, category, user, dT) {

    var sched = {
      'summary': summary,
      'location': 'none',
      'description': 'Category: ' + category + '\n User:' + user,
      'start': {
        'dateTime': (dT.substring(0,10).replace(/\//g, '-') + 'T15:00:00-07:00'),
      },
      'end': {
        'dateTime': (dT.substring(0,10).replace(/\//g, '-') + 'T16:00:00-07:00'),
      }
    };
    return sched;
  }

  var makeRequest = function(resource) {
    var request = gapi.client.calendar.events.insert({
      'calendarId': 'primary',
      'resource': resource
    });
    request.execute(function(resp) {
      appendPre('Event created: ' + resp.htmlLink);
    });
  };

  function listUpcomingEvents() {
    var pre = document.getElementById('content');
    if (pre.style.display == "none") {
    pre.style.display = "block";
    gapi.client.calendar.events.list({
      'calendarId': 'primary',
      'timeMin': (new Date()).toISOString(),
      'showDeleted': false,
      'singleEvents': true,
      'maxResults': 10,
      'orderBy': 'startTime'

    }).then(function(response) {
      var events = response.result.items;
      appendPre('Upcoming events:');

      if (events.length > 0) {
        for (i = 0; i < events.length; i++) {
          var event = events[i];
          var when = event.start.dateTime;
          if (!when) {
            when = event.start.date;
          }
          appendPre(event.summary + ' (' + when + ')')
        }
      } else {
        appendPre('No upcoming events found.');
      }
    });
  } else {
    pre.style.display = "none";
    pre.innerHTML = '';
  }

}
</script>
</ul>

<p>
  <a class="ml-2" href="{% url 'planner:add_task' %}">+ Add Task</a></p><q cite="">
</q>
{% endblock %}
